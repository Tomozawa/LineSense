# LineSense
NHK24用ラインセンサ基板。BOMは[こちら](https://docs.google.com/spreadsheets/d/12akROPWRgP_KYzk62EP3h0m6oYP8IBUy/edit?usp=sharing&ouid=100044542046978284478&rtpof=true&sd=true)

## バージョン履歴
### ver2.0
12V改良版

## 概要
地面の色(水性塗料でペイントされている)を判別することができるセンサ。白かそれ以外(青、緑、オレンジ、黄、赤のいずれか)かを判別する。地面の下が白色である確率に応じた振幅の正弦波(200&#126;2kHz)がSIG_OUTから出力される。出力された信号を包括線検波することで反射率を取得できる。LEDを200&#126;2kHzで点滅させることで光の反射率をAM変調し、光学フィルタでLEDの波長以外をカットし、ローパスフィルタとカップリングで照明の信号をカットしているため、比較的地面と離れていても実用に耐えられるよう配慮している。これは、センサの位置を高めにすることでフィールドにある傾斜の影響を極力小さくするためである。

## 基板の作り方(推奨)
部品の温度特性を考慮して、未使用時でも3カ月に1回は校正を行うこと。また、実運用時には機械的な振動で半固定抵抗がずれるため、機体を起動させる際に攻勢を行うこと。

### 1. LED点灯回路を組む
Sheet 2/2 の部品を取り付け、CN1に仮の電線をつけ、LEDが点灯することを確認する。また、TP1(テストポイント)から200~2kHzの矩形波が観測されるか確認する。

### 2. 受光回路を組む
Q1, R1, R10, C5を取り付け、白い紙に反射させたLED光に反応することを確認する(200~2kHzの波が確認できるはず)。出力波形はTP2(生信号)またはTP3(カップリング済み信号)で確認できる。信号が弱い場合はR10を時計回りに回すことでゲインを上げる。

### 3. プリアンプ/フィルタ/アンプを組む
残りの部品を取り付け、白い紙に反射させたLED光に反応することを確認する。出力波形はTP5またはコネクタから取ってくる。信号が弱い場合はR5を時計回りに回すことでプリアンプのゲインを上げる。

### 4. 光学フィルタをつける
光センサ(Q1)を20mm平方の青いセロハンで覆う。

### 5. 校正を行う
以下のセクションで説明のある方法で校正を行う。

## 校正の仕方
周囲の照明を出来る限り本番の状況に合わせ、白い紙にセンサを水平に設置して行う。この時の紙との距離は、機体のセンサを搭載した時の高さに合わせる。

### 受光回路の感度の校正
R10を調整しながら周囲の照明による直流成分が4V以下になるようにする。センサの出力はTP2を確認する。R10を時計回りに回すと感度が高くなり、反時計回りに回すと小さくなる。

### LEDの点滅周波数の校正
TP1にオシロスコープのプローブを当て、R16を調整しながらTP1から1kHzの矩形波が出力されるようにする。R16を時計回りに回すと周波数が上がり、反時計回りに回すと周波数が下がる。この時、TP3の信号の振幅が100mVp-pを下回った場合、周波数を落として振幅が100mVp-p以上になるようにする。

### プリアンプのゲインの校正
受光回路のゲイン校正と同様の条件に加え、SIG_OUTに36Ωの負荷抵抗を接続した状態で、R5を調整しながらTP5で出てくる信号が歪まないギリギリまでゲインを上げる。TP5の信号の頂点の部分(約3.0V~3.3V程度)が歪まない(つぶれない)限界までR5を時計回りに回す。
